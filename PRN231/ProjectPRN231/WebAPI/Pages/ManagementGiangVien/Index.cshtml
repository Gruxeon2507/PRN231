@page
@model WebAPI.Pages.ManagementGiangVien.IndexModel
@{
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Giảng Viên Management Page</title>
    <link rel="stylesheet" href="/css/GV.css">
    <link rel="stylesheet" href="/js/GV.js" />
</head>
<body>
    <header>
        <h1>Instructor Management Page</h1>
    </header>
    <a href="/Login_Register" class="btn btn-primary">Log out</a>
    <table id="registedList">
        <thead>
            <tr>
                <th>Registration ID</th>
                <th>Student Name</th>
                <th>Project Title</th>
                <th>Project Description</th>
                <th>Grade</th>
                <th>Notes</th>
                <th>Action</th>
                <th>Deadline</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <div id="deadlineModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Deadline Information</h2>
            <p><strong>Start Date:</strong> <span id="startDate"></span></p>
            <p><strong>End Date:</strong> <span id="endDate"></span></p>
            <button id="updateDeadlineBtn">Update Deadline</button>
            <button id="closeModalBtn">Close</button>
            <div id="updateDeadlineForm" style="display: none;">
                <label for="startDateInput">Start Date:</label>
                <input type="datetime-local" id="startDateInput"><br>
                <label for="endDateInput">End Date:</label>
                <input type="datetime-local" id="endDateInput"><br>
                <button id="saveDeadlineBtn">Save</button>
            </div>
        </div>
    </div>
    <footer>
        <p>&copy; 2023 Instructor Management System</p>
    </footer>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>
        $(document).ready(function () {
            var idNguoiDung = localStorage.getItem("idNguoiDung");
            var registrationId; // Biến registrationId ở phạm vi toàn cục

            function convert(idNguoiDung) {
                $.ajax({
                    url: 'https://localhost:7150/api/GiangVien/GiangVien-id/' + idNguoiDung,
                    type: 'GET',
                    success: function (response) {
                        console.log(response);
                        loadRegisted(response);
                    },
                    error: function (error) {
                        console.error('Error:', error);
                    }
                });
            }

            function loadRegisted(id) {
                $.ajax({
                    url: 'https://localhost:7150/api/GiangVien/StudentsRegisteredByProfessor/' + id,
                    type: 'GET',
                    success: function (registed) {
                        $('#registedList tbody').empty();
                        registed.forEach(function (registedItem) {
                            var row = '<tr>' +
                                '<td>' + registedItem.idDangKy + '</td>' +
                                '<td>' + registedItem.tenSinhVien + '</td>' +
                                '<td>' + registedItem.tenDeTai + '</td>' +
                                '<td>' + registedItem.moTaDeTai + '</td>' +
                                '<td>' + registedItem.diem + '</td>' +
                                '<td>' + registedItem.ghiChu + '</td>' +
                                '<td><button class="gradeButton" data-id="' + registedItem.idDangKy + '">Enter Grade</button></td>' +
                                '<td class="gradeSection" style="display: none;">' +
                                '<input type="text" class="gradeInput" placeholder="Enter Grade">' +
                                '<input type="text" class="noteInput" placeholder="Enter Note">' +
                                '<button class="saveButton">Save</button>' +
                                '<td><button class="viewDeadlineBtn" data-id="' + registedItem.idDangKy + '">View Deadline</button></td>' +
                                '</tr>';
                            $('#registedList tbody').append(row);
                        });
                    },
                    error: function (error) {
                        console.error('Error:', error);
                    }
                });
            }

            convert(idNguoiDung);

            $(document).on('click', '.gradeButton', function () {
                registrationId = $(this).data('id'); // Gán giá trị cho biến registrationId khi click
                $(this).closest('tr').find('.gradeSection').toggle();
            });

            $(document).on('click', '.saveButton', function () {
                var grade = $(this).closest('tr').find('.gradeInput').val();
                var note = $(this).closest('tr').find('.noteInput').val();

                var data = {
                    Diem: grade,
                    GhiChu: note
                };

                $.ajax({
                    url: 'https://localhost:7150/api/GiangVien/getMark/' + registrationId,
                    type: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                    success: function (response) {
                        console.log('Grade and note saved successfully:', response);
                        window.location.reload();

                    },
                    error: function (error) {
                        console.error('Error saving grade and note:', error);
                    }
                });
            });

            // Show deadline modal when View Deadline button is clicked
            // Show deadline modal when View Deadline button is clicked
            $(document).on('click', '.viewDeadlineBtn', function () {
                var registrationId = $(this).data('id');
                $.ajax({
                    url: 'https://localhost:7150/api/GiangVien/Deadline/' + registrationId,
                    type: 'GET',
                    success: function (deadline) {
                        $('#startDate').text(deadline.startDate);
                        $('#endDate').text(deadline.endDate);
                        $('#deadlineModal').show();
                    },
                    error: function (error) {
                        console.error('Error:', error);
                    }
                });
            });


            $('#viewDeadlineBtn').click(function () {
                $.ajax({
                    url: 'https://localhost:7150/api/GiangVien/DeadLine/' + registrationId,
                    type: 'GET',
                    success: function (deadline) {
                        $('#startDate').text(deadline.startDate);
                        $('#endDate').text(deadline.endDate);
                        $('#deadlineModal').show();
                    },
                    error: function (error) {
                        console.error('Error:', error);
                    }
                });
            });

            // Open update deadline form
            $('#updateDeadlineBtn').click(function () {
                $('#updateDeadlineForm').show();
            });

            // Save updated deadline
            $(document).on('click', '.viewDeadlineBtn', function () {
                var registrationId = $(this).data('id');
                $.ajax({
                    url: 'https://localhost:7150/api/GiangVien/DeadLine/1',
                    type: 'GET',
                    success: function (deadline) {
                        $('#startDate').text(deadline.startDate);
                        $('#endDate').text(deadline.endDate);
                        $('#deadlineModal').show();
                    },
                    error: function (error) {
                        console.error('Error:', error);
                    }
                });
            });

            // Open update deadline form
            $('#updateDeadlineBtn').click(function () {
                $('#updateDeadlineForm').show();
            });

            // Save updated deadline
            $('#saveDeadlineBtn').click(function () {
                var startDate = $('#startDateInput').val();
                var endDate = $('#endDateInput').val();

                var updatedDeadline = {
                    StartDate: startDate,
                    EndDate: endDate
                };

                $.ajax({
                    url: 'https://localhost:7150/api/GiangVien/Deadline/1',
                    type: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify(updatedDeadline),
                    success: function (response) {
                        console.log('Deadline updated successfully:', response);
                        $('#deadlineModal').hide();
                        loadRegisted(); // Reload registered list after updating deadline
                    },
                    error: function (error) {
                        console.error('Error updating deadline:', error);
                    }
                });
            });

            // Close modal
            $('.close, #closeModalBtn').click(function () {
                $('#deadlineModal').hide();
            });
        });
    </script>

</body>
</html>
